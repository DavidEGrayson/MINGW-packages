From 18e8c5b2a6cfa6322c15b37d94c1f43ab2d26b78 Mon Sep 17 00:00:00 2001
From: Martell Malone <martellmalone@gmail.com>
Date: Tue, 4 Aug 2015 21:38:13 -0700
Subject: [PATCH 1/3] PECOFF: add the mingw alias for ImageBase

---
 lib/ReaderWriter/PECOFF/LinkerGeneratedSymbolFile.h | 10 +++++++---
 lib/ReaderWriter/PECOFF/PECOFFLinkingContext.cpp    |  2 +-
 lib/ReaderWriter/PECOFF/WriterPECOFF.cpp            |  4 +++-
 3 files changed, 11 insertions(+), 5 deletions(-)

diff --git a/lib/ReaderWriter/PECOFF/LinkerGeneratedSymbolFile.h b/lib/ReaderWriter/PECOFF/LinkerGeneratedSymbolFile.h
index 9bf2c00..aee2251 100644
--- a/lib/ReaderWriter/PECOFF/LinkerGeneratedSymbolFile.h
+++ b/lib/ReaderWriter/PECOFF/LinkerGeneratedSymbolFile.h
@@ -97,13 +97,17 @@ class LinkerGeneratedSymbolFile : public SimpleFile {
 public:
   LinkerGeneratedSymbolFile(const PECOFFLinkingContext &ctx)
       : SimpleFile("<linker-internal-file>"),
-        _imageBaseAtom(*this, ctx.decorateSymbol("__ImageBase"),
+        _imageBaseAtomMSVC(*this, ctx.decorateSymbol("__ImageBase"),
+                       Atom::scopeGlobal, ctx.getBaseAddress()),
+        _imageBaseAtomGNU(*this, ctx.decorateSymbol("__image_base__"),
                        Atom::scopeGlobal, ctx.getBaseAddress()) {
-    addAtom(_imageBaseAtom);
+    addAtom(_imageBaseAtomMSVC);
+    addAtom(_imageBaseAtomGNU);
   }
 
 private:
-  SimpleAbsoluteAtom _imageBaseAtom;
+  SimpleAbsoluteAtom _imageBaseAtomMSVC;
+  SimpleAbsoluteAtom _imageBaseAtomGNU;
 };
 
 // A LocallyImporteSymbolFile is an archive file containing __imp_
diff --git a/lib/ReaderWriter/PECOFF/PECOFFLinkingContext.cpp b/lib/ReaderWriter/PECOFF/PECOFFLinkingContext.cpp
index ebd42f8..2bd0e9c 100644
--- a/lib/ReaderWriter/PECOFF/PECOFFLinkingContext.cpp
+++ b/lib/ReaderWriter/PECOFF/PECOFFLinkingContext.cpp
@@ -146,7 +146,7 @@ void PECOFFLinkingContext::createImplicitFiles(
       llvm::make_unique<pecoff::EntryPointFile>(*this)));
   members.insert(members.begin() + getGroupStartPos(members), std::move(entry));
 
-  // Create a file for __ImageBase.
+  // Create a file for __ImageBase and __image_base__.
   std::unique_ptr<FileNode> fileNode(new FileNode(
       llvm::make_unique<pecoff::LinkerGeneratedSymbolFile>(*this)));
   members.push_back(std::move(fileNode));
diff --git a/lib/ReaderWriter/PECOFF/WriterPECOFF.cpp b/lib/ReaderWriter/PECOFF/WriterPECOFF.cpp
index 4c6309a..b240d2b 100644
--- a/lib/ReaderWriter/PECOFF/WriterPECOFF.cpp
+++ b/lib/ReaderWriter/PECOFF/WriterPECOFF.cpp
@@ -791,7 +791,9 @@ void AtomChunk::addBaseRelocations(std::vector<BaseReloc> &relocSites) const {
       // because that's relative to run-time image base address.
       if (auto *abs = dyn_cast<AbsoluteAtom>(ref->target()))
         if (!abs->name().equals("__ImageBase") &&
-            !abs->name().equals("___ImageBase"))
+            !abs->name().equals("___ImageBase") &&
+            !abs->name().equals("__image_base__") &&
+            !abs->name().equals("___image_base__"))
           continue;
 
       uint64_t address = layout->_virtualAddr + ref->offsetInAtom();
-- 
2.4.6

